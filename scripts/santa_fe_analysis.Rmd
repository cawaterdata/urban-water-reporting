---
title: "Template Analysis Urban Water Managment"
author: "Erin Cain"
date: "2/1/2022"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)

```

## Template Analysis for Urban Water Managment 

Currently we can use this template to streamline analysis BUT there is still a lot of manual work. It would be ideal if we could map through all the reports/metrics/agencies efficiently BUT before we can do that we need to have all metric pairs and report pairs generated. 

TODO discuss which approach makes most sense given quantity of analyzes we hope to get through. 
 
## What Reports are we looking at? 

```{r}
report_1 <- "Urban Water Managment Plan"
report_2 <- "Water Loss Report"
report_3 <- "Conservation Report"
report_4 <- "Electronic Annual Report"
```

## What Metric are we comparing between the reports?

```{r}
metric <- "Volume Water Supplied in Acre Feet"
```

## What data are we using?

Tables Names: 

* Report 1: (source)
* Report 2: (source)
* Report 3: (source)
* Report 4: (source)

What agency are we focused on? 

```{r}
agency_of_interest <- "Sante Fe Irrigarion District"
```


Load in data: 
```{r, warning=FALSE, message=FALSE}
data_report_1 <- readxl::read_excel("../data-raw/uwmp_table_2_2_r_conv_to_af.xlsx") %>% 
  filter(WATER_SUPPLIER_NAME == "Santa Fe Irrigation District")
data_report_1
  
data_report_2 <- readxl::read_excel("../data-raw/water_audit_data_conv_to_af.xlsx") %>% 
  filter(REPORTING_YEAR == 2020, WATER_SUPPLIER_NAME == "Santa Fe Irrigation District")
data_report_2

data_report_3 <- readxl::read_excel("../data-raw/conservation-report-uw-supplier-data120721.xlsx") %>% 
  mutate(year = lubridate::year(`Reporting Month`)) %>%
  filter(year == 2020, `Supplier Name` == "Santa Fe Irrigation District") %>%
  glimpse()
data_report_3


# TODO figure out EAR
data_report_4 <-  read.delim("../data-raw/EAR_ResultSet_2020RY.txt")

data_report_4 <- data_report_4 %>%
  filter(WSSurveyID == 428915) %>%
  filter(SurveyName == "2020 EAR", SectionID %in% c("06 Supply-Delivery", "01 Intro")) %>%
  glimpse()

```

### How is our chosen metric described in the report data?

```{r}
volume_supplied_report_1 <- "VOLUME_OF_WATER_SUPPLIED_AF"
volume_supplied_report_2 <- "WS_WATER_SUPPLIED_VOL_AF"
volume_supplied_report_3 <- "REPORTED FINAL Total Potable Water Production"
volume_supplied_report_4 <- "WPAnnualTotal"
```


```{r}
metric_report_1 <- data_report_1 %>% pull(volume_supplied_report_1)
metric_report_1

metric_report_2 <-  data_report_2 %>% pull(volume_supplied_report_2)
metric_report_2 

#Check Units
data_report_3 %>% pull(`Water Production Units`) 

# Units are in AF
metric_report_3 <-  sum(data_report_3 %>% pull(volume_supplied_report_3))
metric_report_3 

# Check Units 
data_report_4 %>% filter(QuestionName == "WPUnitsofMeasure") %>% pull(QuestionResults)


# Units are in AF
metric_report_4 <-  data_report_4 %>% filter(QuestionName == "WPAnnualTotal") %>% pull(QuestionResults)
metric_report_4 

supply_by_report <- tibble("Report" = c(report_1, report_2, report_3, report_4),
                           "Annual AF Supply" = as.numeric(c(metric_report_1, metric_report_2, metric_report_3, metric_report_4)))


library(ggplot2)
ggplot(supply_by_report, aes(x = Report, y = `Annual AF Supply`)) +
  geom_col()
```

#### Delta in Supply for UWMP and WLR
```{r}
delta_water_supplied <- metric_report_1 - metric_report_2
delta_water_supplied
delta_water_supplied_percent <- (metric_report_1 / metric_report_2 - 1) * 100
```

The *difference* in the `r metric` between the `r report_1` and `r report_2` is: `r delta_water_supplied` Acre Feet. 

The *percent difference* is: `r delta_water_supplied_percent` %.

## TODO add these sections for others (or incoperate into graph)

## If % differnce is significant (define what significant is), why is it different?

